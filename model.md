# Model

## Overview

The `model` application is used to run ModelPack trained models using camera frames sent from the `camera` app. The `model` application supports detection and segmentation models. The output(s) from the ModelPack models are sent out using zenoh messaging. Segmentation masks can optionally be compressed using zstd compression, which is used to reduce bandwidth requirements when livestreaming the model outputs.

After the output(s) are recorded into an `.mcap` file using the `recorder`, the detection or segmentation output can be view in Foxglove, with the help of the EdgeFirstDetect Foxglove plugin.

## Settings

The settings for the `model` application can be access on the Settings page under "Model Settings", or accessed directly via `https://hostname/config/model`.

| Setting Name             | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Default                           |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------- |
| Model                    | The path to the model file on the board. Use absolute paths.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | /usr/share/model/peoplesegdet.rtm |
| Visualization            | Enables publishing the legacy visualization message for detection models.<br />When set to `false`, the primary model box and mask topics will be available. <br /> If using Foxglove Studio make sure you install the EdgeFirst for Foxglove Plug-in, refer to the documentation for details.                                                                                                                                                                                                                                                                                                                                    | false                             |
| Labels                   | Annotation labels can display various information.  This controls the string annotation published to the visualization topic.<br />The following values are supported:<br />`index` - Label index integer as a string<br />`score` - Floating-point score (0..1) as a string<br />`label` - Label string, fallback to index if model does not contain labels<br />`label-score` - The string will be the the combination of Label and Score using the following format: "Label Score"<br />`track` - The UUID of the tracked object. This is only available when tracking is enabled. Otherwise will show the score. | label                             |
| Threshold                | Score threshold sets the minimum detection score before a bounding box is generated for the inferred object for detection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 0.2                               |
| IOU                      | Detection IOU controls the minimum overlap for merging boxes during NMS.<br />A larger number will produce more boxes with some overlap while a smaller number will generate fewer boxes.                                                                                                                                                                                                                                                                                                                                                                                                                                          | 0.2                               |
| Max Boxes                | Maximum number of boxes which can be generated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 50                                |
| Label Offset             | The label offset is required for certain models to account for differences in background class handling relative to the labels.txt.<br />It should usually be zero but some odd configurations will sometimes require 1 or -1 for offset.                                                                                                                                                                                                                                                                                                                                                                                          | 0                                 |
| Engine                   | The model can be run using different computation engines.<br />The following values are supported:<br />`NPU`<br />`CPU`<br />`GPU`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | NPU                               |
| Track                    | Turn on the ByteTrack tracker.<br />This is useful for smoothing bounding boxes across frames, and for associating multiple detections over time to a single object                                                                                                                                                                                                                                                                                                                                                                                                                                                                | true                              |
| Track Extra Lifespan (s) | The number of seconds a tracked object can be missing for before being removed from tracking.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | 0.5                               |
| Track High Conf          | The high confidence threshold for the ByteTrack algorithm.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 0.4                               |
| Track IOU                | The tracking iou threshold for box association.<br />Higher values will require boxes to have higher IOU to the predicted track location to be associated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 0.25                              |
| Track Update             | The tracking update factor. Higher update factor will mean less smoothing but more rapid response to change.<br />Use values from 0.0 to 1.0. Values outside this range will cause unexpected behaviour.                                                                                                                                                                                                                                                                                                                                                                                                                           | 0.25                              |
| Mask Compression         | Enable compression for segmentation masks.<br /> When enabled both the /model/mask and /model/mask_compressed topics will be available. <br /> The compressed mask should be used from remote connections.<br />The un-compressed topic should be used from local connections to avoid redundant compress/decompress steps.                                                                                                                                                                                                                                                                                                        | true                              |

## Details

### Loading the Model

The model is loaded using VAAL. Based on the engine chosen, the VAAL context will be opened on the NPU, GPU, or CPU. After the model is loaded, the application will identify the type of model (detection, segmentation, or both) it is. This information is included in the `/model/info` message, along with information about the model name, model format, input tensor, output tensor, etc. The model info message is sent every time a camera frame is recieved.

### Running the Model

After the model is loaded and identified, the camera frames are recieved using from `camera` via the `/camera/dma` and loaded into the model input using DMA buffer memory sharing. Due to this, the `model` application must run with the same or highest permissions as `camera`. After loading the input frames and running the model, the outputs are read from the model.

For detection models, VAAL is used to decode the boxes and do NMS processing. Next, if tracking is not enabled, the detected boxes are published on `/model/boxes2d`. Otherwise, the boxes are processed by the ByteTrack tracker and any existing tracks are published on `/model/boxes2d`.

For segmentation models, the model output is copied out from the tensor and published on `/model/mask`. If compression is enabled, the mask will also be compressed using zstd and published on `/model/mask_compressed`. This compression occurs on a seperate thread. The compression takes around 5ms for 1x240x320x2 segmentation mask.
